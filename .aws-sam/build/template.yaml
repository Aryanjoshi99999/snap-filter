AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'snap-filter A serverless application that resizes images uploaded to
  S3.

  '
Resources:
  ImageProcessingDLQ:
    Type: AWS::SQS::Queue
  ImageProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 120
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - ImageProcessingDLQ
          - Arn
        maxReceiveCount: '5'
  ImageUploadBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
  ThumbnailBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
  ImageAnalysisTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ImageAnalysisResults
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: ImageId
        AttributeType: S
      KeySchema:
      - AttributeName: ImageId
        KeyType: HASH
  ImageProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ImageProcessorFunction
      Handler: app.handler
      Runtime: python3.12
      MemorySize: 256
      Timeout: 30
      Policies:
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - ImageProcessingQueue
            - QueueName
      - S3ReadPolicy:
          BucketName:
            Ref: ImageUploadBucket
      - S3WritePolicy:
          BucketName:
            Ref: ThumbnailBucket
      - DynamoDBWritePolicy:
          TableName:
            Ref: ImageAnalysisTable
      - Statement:
        - Effect: Allow
          Action:
          - rekognition:DetectLabels
          Resource: '*'
      Environment:
        Variables:
          DESTINATION_BUCKET:
            Ref: ThumbnailBucket
          RESULTS_TABLE:
            Ref: ImageAnalysisTable
      Events:
        MySQSEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - ImageProcessingQueue
              - Arn
            BatchSize: 1
    Metadata:
      SamResourceId: ImageProcessorFunction
Outputs:
  ImageUploadBucketName:
    Description: Name of the S3 bucket for image uploads
    Value:
      Ref: ImageUploadBucket
  ThumbnailBucketName:
    Description: Name of the S3 bucket for resized thumbnails
    Value:
      Ref: ThumbnailBucket
  ImageProcessingQueueArn:
    Description: ARN of the SQS queue receiving S3 notifications
    Value:
      Fn::GetAtt:
      - ImageProcessingQueue
      - Arn
  ImageProcessingQueueUrl:
    Description: URL of the SQS queue
    Value:
      Ref: ImageProcessingQueue
  ImageAnalysisTableName:
    Description: Name of DynamoDB table storing AI analysis results
    Value:
      Ref: ImageAnalysisTable
